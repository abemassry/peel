<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Distribtr</title>
  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<style>
  .navbar-light {
    background-color: #F5F5DC !important;
  }
</style>
</head>
<body>
  <nav class="navbar navbar-custom sticky-top navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <svg height="20" width="20">
          <circle cx="10" cy="10" r="5" stroke="black" stroke-width="3" fill="beige" />
        </svg>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-search"></i>
      </button>

      <div class="collapse navbar-collapse" id="navbarColor01">
        <ul class="navbar-nav me-auto">
        </ul>
        <form class="d-flex">
          <input class="form-control me-sm-2" type="text" placeholder="Search">
          <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
        </form>
      </div>
    </div>
  </nav>

  <div id="content" class="container">


    <button id="send" style="display: none;">Send Message</button>
    <p>DistribtrID<span id="distribtrID"></span></p>
    <p>Connected To:<span id="peerDistribtrID"></span></p>

    <div class="card">
      <div class="card-header">
        Featured
      </div>
      <div class="card-body">
        <h5 class="card-title">Special title treatment</h5>
        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
        <a href="#" class="btn btn-primary">Go somewhere</a>
      </div>
    </div>


  </div>

  <nav class="navbar navbar-custom fixed-bottom navbar-light bg-light d-xs-block d-sm-block d-md-block d-lg-none d-xl-none">
    <div class="container-fluid">
      <button class="navbar-toggler"  type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-house-door-fill"></i>
      </button>
      <button class="navbar-toggler"  type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor03" aria-controls="navbarColor03" aria-expanded="false" aria-label="Toggle navigation">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-plus-square"></i>
      </button>
      <button class="navbar-toggler"  type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor04" aria-controls="navbarColor04" aria-expanded="false" aria-label="Toggle navigation">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-list"></i>
      </button>

    </div>
  </nav>


<!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
<script>
window.addEventListener('load', function() {
const VERSION = "0_29_0";
var distribtrID = 0;
var peerDistribtrID = 0;
const peerDistribtrS = {};
var firstTry = true;
var firstTryPeer = true;
var peer;
var peerConn;
  var connected = false;

  function sendMessage() {
    var dataToSend = {
      "originator": distribtrID,
      "src_peer_id": distribtrID,
      "dest_peer_id": peerDistribtrID,
      "message": "Hello from "+distribtrID +" trying to send to "+ peerDistribtrID,
      "peers": [distribtrID]
    };
    console.log(dataToSend);
    console.log('sending');
    peerConn.send(JSON.stringify(dataToSend));
    for (const [newID, newPeerConn] of Object.entries(peerDistribtrS)) {
      newPeerConn.send(JSON.stringify(dataToSend));
    }
  }

  function pollForMessages() {
    var dataToSend = {
      "originator": distribtrID,
      "src_peer_id": distribtrID,
      "dest_peer_id": peerDistribtrID,
      "ping": true
    };
    peerConn.send(JSON.stringify(dataToSend));
  }

  function addSymmetricConnection(newID, newDataObj) {
    let peerError = false;
    console.log("attempting new peer connection "+newID);
    const pConn = peer.connect(VERSION+'_Distribtr' + newID);
    // on open will be launch when you successfully connect to PeerServer
    console.log(pConn);
    pConn.on('open', function(){
      // here you have conn.id
      console.log("attempting connection, reconnectPeer open");
      console.log(distribtrID);
      peerDistribtrS[newID] = pConn;
      console.log("peerDistribtrS:");
      console.log(peerDistribtrS);
      connected = true;
      pConn.send(JSON.stringify(newDataObj));
    });
    pConn.on('error', function(err){
      console.log("got an error pConn");
      peerError = true;
      connected = false;
      console.log(err);
      return;
    });
    //pConn.send('hi from server');
    if (peerError) {
      return;
    }

  }

  function reconnectPeer() {
    if (distribtrID === peerDistribtrID) {
      connected = false;
      peerDistribtrID++;
      reconnectPeer();
      return;
    }
    firstTryPeer = false;
    var peerError = false;
    console.log("attempting peer connection "+peerDistribtrID);
    peerConn = peer.connect(VERSION+'_Distribtr' + peerDistribtrID);
    // on open will be launch when you successfully connect to PeerServer
    console.log(peerConn);
    peerConn.on('open', function(){
      // here you have conn.id
      console.log("attempting connection, reconnectPeer open");
      console.log(distribtrID);
      var displayID = document.getElementById("distribtrID");
      var connectionDisplayID = document.getElementById("peerDistribtrID");
      displayID.innerHTML = distribtrID;
      connectionDisplayID.innerHTML = peerDistribtrID;
      var sendButton = document.getElementById("send");
      sendButton.style.display = "inline";
      sendButton.addEventListener("click", sendMessage);
      //setInterval(pollForMessages, 5000);
      connected = true;
    });
    peerConn.on('error', function(err){
      console.log("got an error peerConn");
      peerError = true;
      connected = false;
      console.log(err);
      setTimeout(function() {
        peerDistribtrID++;
        reconnectPeer();
        return;
      }, 2000);
      return;
    });
    //peerConn.send('hi from server');
    if (peerError) {
      return;
    }

  }


  function reconnectSetup() {
    firstTry = false;
    console.log("reconnectSetup");
    namespaceID = VERSION + "_Distribtr" + distribtrID
    peer = new Peer(namespaceID);
    peer.on('open', function(namespaceID) {
      console.log('reconnection My peer ID is: ' + namespaceID);
      localStorage.setItem("sequential_peer_id", namespaceID);
      // send event for trying to connect to other peers
      peerDistribtrID++;
      reconnectPeer();
    });
    peer.on('connection', function(conn) {
      conn.on('data', function(data){
        // Will print 'hi!'
        console.log(data);
        if (connected) {
          var dataObj = JSON.parse(data);
          console.log("got:");
          console.log(dataObj);
          if (dataObj.ping) {
            console.log(dataObj);
          } else {
            let newDataObj = Object.assign({}, dataObj);
            newDataObj.src_peer_id = distribtrID;
            newDataObj.dest_peer_id = peerDistribtrID;

            // send fanout
            for (const [newID, newPeerConn] of Object.entries(peerDistribtrS)) {
              if (dataObj.src_peer_id !== newID) {
                console.log("sending from: "+ distribtrID+ ", to: "+peerDistribtrID);
                console.log("dataObj.src_peer_id: "+dataObj.src_peer_id);
                newPeerConn.send(JSON.stringify(newDataObj));
              }
            }

            if (dataObj.src_peer_id !== peerDistribtrID && dataObj.originator !== peerDistribtrID && dataObj.src_peer_id !== distribtrID && dataObj.originator !== distribtrID) {
              console.log("sending from: "+ distribtrID+ ", to: "+peerDistribtrID);
              console.log("dataObj.src_peer_id: "+dataObj.src_peer_id);
              peerConn.send(JSON.stringify(newDataObj));
              console.log("new peer found me");
              console.log(dataObj.src_peer_id);
              let idCount = 0;
              let found = false;
              for (const [id, pc] of Object.entries(peerDistribtrS)) {
                idCount++;
                console.log("for: "+id);
                if (dataObj.src_peer_id === id) {
                  found = true;
                  next;
                }
              }
              if (idCount === 0 || found === false) {
                addSymmetricConnection(dataObj.src_peer_id, newDataObj);
              }

              console.log(peerDistribtrS);
              for (const [newID, newPeerConn] of Object.entries(peerDistribtrS)) {
                if (dataObj.src_peer_id !== newID) {
                  console.log("sending from: "+ distribtrID+ ", to: "+peerDistribtrID);
                  console.log("dataObj.src_peer_id: "+dataObj.src_peer_id);
                  newPeerConn.send(JSON.stringify(newDataObj));
                }
              }
              return;
            }
          }
        }

      });
    });
    peer.on('error', function(err) {
      connected = false;
      console.log("got an error reconnectSetup");
      console.log(err);
      console.log(String(err));
      console.log(err.Error);
      distribtrID++;
      setTimeout(function() {
        reconnectSetup();
      }, 1000);
      return;
    });

  }


  var sequential_peer_id;


  if (localStorage.getItem("sequential_peer_id") === null) {
    peer = new Peer();
  } else {
    sequential_peer_id = localStorage.getItem("sequential_peer_id");
    peer = new Peer(sequential_peer_id);
  }
  reconnectSetup();

})
</script>
</html>
