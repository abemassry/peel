<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Peel</title>
  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<style>
  .navbar-light {
    background-color: #F5F5DC !important;
  }
  .modal-content {
    background-color: #F5F5DC !important;
  }
  #offcanvasRight {
    background-color: #F5F5DC !important;
  }
  #connection-status-icon {
    color: #e4ba1a;
  }
  #connection-status-count {
    font-size: 13px;
    text-align: center;
  }
  #drop-area {
    border: 2px dashed #ccc;
    border-radius: 20px;
    width: 100%;
    margin: 50px auto;
    padding: 20px;
  }
  #drop-area.highlight {
    border-color: purple;
    background-color: grey;
  }
  #gallery {
    margin-top: 10px;
  }
  #gallery img {
    width: 150px;
    margin-bottom: 10px;
    margin-right: 10px;
    vertical-align: middle;
  }
  .upload-button {
    display: inline-block;
    padding: 10px;
    background: #ccc;
    cursor: pointer;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  .upload-button:hover {
    background: #ddd;
  }
  #fileElem {
    display: none;
  }
  .info {
    text-align: center;
  }
  #error {
    color: red;
  }

  body {
    background-color: #F5F5DC !important;
  }
</style>
</head>
<body>
  <nav class="navbar navbar-custom sticky-top navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <svg height="20" width="20">
          <circle cx="10" cy="10" r="5" stroke="black" stroke-width="3" fill="beige" />
        </svg>
        &nbsp;
        Peel
      </a>
      <div id="connection-container">
        <span id="connection-status">Connecting</span>&nbsp;<i id="connection-status-icon" class="bi bi-circle-fill"></i>&nbsp;<span id="connection-status-count"></span>
      </div>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-search"></i>
      </button>

      <div class="collapse navbar-collapse" id="navbarColor01">
        <ul class="navbar-nav me-auto">
        </ul>
        <form class="d-flex">
          <input class="form-control me-sm-2" type="text" placeholder="Search">
          <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
        </form>
      </div>
    </div>
  </nav>

  <div id="content" class="container">

    <div class="row">
      <div class="col d-none d-sm-none d-md-none d-lg-block">
        About links
      </div>

      <div id="message-holder" class="col-lg-8">
      </div>

      <div class="col d-none d-sm-none d-md-none d-lg-block">
        Util Links
      </div>
    </div>




    <br />
    <br />
    <br />
    <br />

  </div>



  <nav class="navbar navbar-custom fixed-bottom navbar-light bg-light d-xs-block d-sm-block d-md-block d-lg-none d-xl-none">
    <div class="container-fluid">
      <button class="navbar-toggler"  type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-house-door-fill"></i>
      </button>
      <button class="navbar-toggler btn" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-plus-square"></i>
      </button>
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" aria-expanded="false" aria-label="Toggle sidebarRight">
        <!--<span class="navbar-toggler-icon"></span>-->
        <i class="bi bi-list"></i>
      </button>

    </div>
  </nav>

  <!-- Post Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">New Post</h5>
          <button type="button" class="btn close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" id="post-modal-textarea" rows="5"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="post-modal-button" data-bs-dismiss="modal" class="btn btn-success">Post</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Sidebar if mobile -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasRightLabel">Peel</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      Version: <span id="version-string"></span><br />
      NodeID: <span id="node-id"></span><br />
      PeerNodeID: <span id="peer-node-id"></span><br/>
      ConnectedAdditionalPeers: <span id="connected-additional-peers"></span><br />
    </div>
  </div>

  <!-- Create Username Modal -->
  <div class="modal fade" id="createUserModal" tabindex="-1" role="dialog" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createUserModalLabel">
            <svg height="20" width="20">
              <circle cx="10" cy="10" r="5" stroke="black" stroke-width="3" fill="beige" />
            </svg>
            Peel &nbsp; Create Your Peel User
          </h5>
          <button type="button" class="btn close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control" id="exampleFormControlInput1" placeholder="username">
          <div id="drop-area">
            <form class="my-form">
              <p>Drag and drop profile picture.</p>
              <input type="file" id="fileElem" onchange="handleFiles(this.files)">
              <label class="upload-button" for="fileElem">Select an image</label>
            </form>
            <div id="gallery" /></div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="post-modal-button" data-bs-dismiss="modal" class="btn btn-success">Create</button>
        </div>
      </div>
    </div>
  </div>

<!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
<script>
  window.addEventListener('load', function() {
  const VERSION = "0_44_0";
  document.getElementById("version-string").textContent = VERSION.replace(/_/g, ".");
  var distribtrID = 0;
  var peerDistribtrID = 0;
  let sendLimit = 10;
  const peerDistribtrS = {};
  var firstTry = true;
  var firstTryPeer = true;
  var peer;
  var peerConn;
  var connected = false;
  let allData = {};
  allData["users"] = {};
  allData["messages"] = {};

  let sendIntervalID = setInterval(function() {
    if (sendLimit < 10) {
      sendLimit++;
    }
  }, 2000);

  function mergeData(newAllData) {
    for (let key of Object.keys(newAllData.users)) {
      if (typeof allData.users[key] === "undefined") {
        allData.users[key] = newAllData.users[key];
      }
    }
    for (let key of Object.keys(newAllData.messages)) {
      if (typeof allData.messages[key] === "undefined") {
        allData.messages[key] = newAllData.messages[key];
      }
    }
  }

  function sendMessage() {
    var dataToSend = {
      "originator": distribtrID,
      "src_peer_id": distribtrID,
      "dest_peer_id": peerDistribtrID,
      "message": allData,
      "peers": [distribtrID]
    };
    console.log(dataToSend);
    console.log('sending');
    peerConn.send(JSON.stringify(dataToSend));
    for (const [newID, newPeerConn] of Object.entries(peerDistribtrS)) {
      newPeerConn.send(JSON.stringify(dataToSend));
    }
  }

  function pollForMessages() {
    var dataToSend = {
      "originator": distribtrID,
      "src_peer_id": distribtrID,
      "dest_peer_id": peerDistribtrID,
      "ping": true
    };
    peerConn.send(JSON.stringify(dataToSend));
  }

  function addSymmetricConnection(newID, newDataObj) {
    let peerError = false;
    console.log("attempting new peer connection "+newID);
    const pConn = peer.connect(VERSION+'_Distribtr' + newID);
    // on open will be launch when you successfully connect to PeerServer
    pConn.on('open', function(){
      // here you have conn.id
      console.log("attempting connection, reconnectPeer open");
      console.log(distribtrID);
      peerDistribtrS[newID] = pConn;
      console.log("peerDistribtrS:");
      console.log(peerDistribtrS);
      connected = true;
      updateConnectionStatus();
      pConn.send(JSON.stringify(newDataObj));
    });
    pConn.on('error', function(err){
      console.log("got an error pConn");
      peerError = true;
      console.log(err);
      pConn.close();
      return;
    });
    //pConn.send('hi from server');
    if (peerError) {
      return;
    }

  }

  function reconnectPeer() {
    if (distribtrID === peerDistribtrID) {
      connected = false;
      updateConnectionStatus();
      peerDistribtrID++;
      reconnectPeer();
      return;
    }
    firstTryPeer = false;
    var peerError = false;
    console.log("attempting peer connection "+peerDistribtrID);
    peerConn = peer.connect(VERSION+'_Distribtr' + peerDistribtrID);
    // on open will be launch when you successfully connect to PeerServer
    console.log(peerConn);
    peerConn.on('open', function(){
      // here you have conn.id
      console.log("attempting connection, reconnectPeer open");
      console.log(distribtrID);
      //setInterval(pollForMessages, 5000);
      connected = true;
      updateConnectionStatus();
    });
    peerConn.on('error', function(err){
      console.log("got an error peerConn");
      peerError = true;
      connected = false;
      updateConnectionStatus();
      console.log(err);
      setTimeout(function() {
        peerDistribtrID++;
        reconnectPeer();
        return;
      }, 2000);
      return;
    });
    //peerConn.send('hi from server');
    if (peerError) {
      return;
    }

  }


  function reconnectSetup() {
    firstTry = false;
    console.log("reconnectSetup");
    namespaceID = VERSION + "_Distribtr" + distribtrID
    peer = new Peer(namespaceID);
    peer.on('open', function(namespaceID) {
      console.log('reconnection My peer ID is: ' + namespaceID);
      localStorage.setItem("sequential_peer_id", namespaceID);
      // send event for trying to connect to other peers
      peerDistribtrID++;
      reconnectPeer();
    });
    peer.on('connection', function(conn) {
      conn.on('data', function(data){
        if (connected) {
          sendLimit--;
          if (sendLimit < 1) {
            return;
          }
          var sendList = {};
          var dataObj = JSON.parse(data);
          console.log("got:");
          console.log(dataObj);
          mergeData(dataObj.message);
          Object.keys(allData.messages).reduceRight(renderMessages, null);
          if (dataObj.ping) {
            console.log(dataObj);
          } else {
            let newDataObj = Object.assign({}, dataObj);
            newDataObj.src_peer_id = distribtrID;
            newDataObj.dest_peer_id = peerDistribtrID;

            // send fanout
            for (const [newID, newPeerConn] of Object.entries(peerDistribtrS)) {
              if (dataObj.src_peer_id !== newID && typeof sendList[newID] === "undefined") {
                console.log("sending from: "+ distribtrID+ ", to: "+peerDistribtrID);
                console.log("dataObj.src_peer_id: "+dataObj.src_peer_id);
                newPeerConn.send(JSON.stringify(newDataObj));
                sendList[newID] = true;
              }
            }

            if (dataObj.src_peer_id !== peerDistribtrID && dataObj.originator !== peerDistribtrID && dataObj.src_peer_id !== distribtrID && dataObj.originator !== distribtrID) {
              console.log("sending from: "+ distribtrID+ ", to: "+peerDistribtrID);
              console.log("dataObj.src_peer_id: "+dataObj.src_peer_id);
              peerConn.send(JSON.stringify(newDataObj));
              console.log("new peer found me");
              console.log(dataObj.src_peer_id);
              let idCount = 0;
              let found = false;
              for (const [id, pc] of Object.entries(peerDistribtrS)) {
                idCount++;
                console.log("for: "+id);
                if (dataObj.src_peer_id === id) {
                  found = true;
                  next;
                }
              }
              if (idCount === 0 || found === false) {
                addSymmetricConnection(dataObj.src_peer_id, newDataObj);
              }

              for (const [newID, newPeerConn] of Object.entries(peerDistribtrS)) {
                if (dataObj.src_peer_id !== newID && typeof sendList[newID] === "undefined") {
                  console.log("sending from: "+ distribtrID+ ", to: "+peerDistribtrID);
                  console.log("dataObj.src_peer_id: "+dataObj.src_peer_id);
                  newPeerConn.send(JSON.stringify(newDataObj));
                  sendList[newID] = true;
                }
              }
              return;
            }
          }
        }

      });
    });
    peer.on('error', function(err) {
      connected = false;
      updateConnectionStatus();
      console.log("got an error reconnectSetup");
      console.log(String(err));
      distribtrID++;
      peerDistribtrID = 0;
      setTimeout(function() {
        reconnectSetup();
      }, 1000);
      return;
    });

  }


  var sequential_peer_id;


  if (localStorage.getItem("sequential_peer_id") === null) {
    peer = new Peer();
  } else {
    sequential_peer_id = localStorage.getItem("sequential_peer_id");
    peer = new Peer(sequential_peer_id);
  }
  reconnectSetup();

  //
  // UI interaction section
  //

  displayUserCreate();

  const displayedMessages = {};

  const card = document.createElement("div");
  card.classList.add("card");
  const cardBody = document.createElement("div");
  cardBody.classList.add("card-body");
  const h6 = document.createElement("h6");
  h6.classList.add("card-title");
  const cardText = document.createElement("p");
  cardText.classList.add("card-text");
  const cardFooter = document.createElement("div");
  cardFooter.classList.add("card-footer");
  cardBody.append(h6);
  cardBody.append(cardText);
  card.append(cardBody);
  card.append(cardFooter);

  const messageHolder = document.getElementById("message-holder");

  function renderMessages(_, index) {
    if (displayedMessages[index]) {
      return;
    }
    const message = allData.messages[index];
    const newCard = card.cloneNode(true);
    newCard.getElementsByClassName("card-title")[0].append(message.user);
    newCard.getElementsByClassName("card-text")[0].append(message.text);
    messageHolder.prepend(newCard);
    displayedMessages[index] = true;
  }
  if (allData.messages.length > 0) {
    console.log("about to render");
    Object.keys(allData.messages).reduceRight(renderMessages, null);
  }

  function getRandomInt(max) {
    return Math.floor(Math.random() * max);
  }
  document.getElementById("post-modal-button").onclick = function() {
    const postContent = document.getElementById("post-modal-textarea").value;
    console.log("post pressed");
    console.log(postContent);
    const now = Date.now();
    const strNow = now.toString() + getRandomInt(9).toString();
    const nowInt = parseInt(strNow);
    allData.messages[nowInt] = {
      "user": "user1",
      "text": postContent
    };
    document.getElementById("post-modal-textarea").value = "";
    console.log(allData);
    Object.keys(allData.messages).reduceRight(renderMessages, null);
    sendMessage();
  };

  function updateConnectionStatus() {
    if (connected) {
      document.getElementById("connection-status").textContent = "Connected";
      document.getElementById("connection-status-icon").style.color = "#28a745";
      document.getElementById("connection-status-count").textContent = "";
      document.getElementById("node-id").textContent = distribtrID;
      document.getElementById("peer-node-id").textContent = peerDistribtrID;
    } else {
      document.getElementById("connection-status").textContent = "Connecting";
      document.getElementById("connection-status-icon").style.color = "#e4ba1a";
      document.getElementById("connection-status-count").textContent = distribtrID;
    }
  }

  function displayUserCreate() {
    if (localStorage.getItem('userdata') === null) {
      const createUserModal = new bootstrap.Modal(document.getElementById('createUserModal'));
      createUserModal.show();
    }
  }

  // ************************ Drag and drop ***************** //
  let dropArea = document.getElementById("drop-area")

  // Prevent default drag behaviors
  ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false)   
    document.body.addEventListener(eventName, preventDefaults, false)
  })

  // Highlight drop area when item is dragged over it
  ;['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false)
  })

  ;['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false)
  })

  // Handle dropped files
  dropArea.addEventListener('drop', handleDrop, false)

  function preventDefaults (e) {
    e.preventDefault()
    e.stopPropagation()
  }

  function highlight(e) {
    dropArea.classList.add('highlight')
  }

  function unhighlight(e) {
    dropArea.classList.remove('active')
    dropArea.classList.remove('highlight')
  }

  function handleDrop(e) {
    var dt = e.dataTransfer
    var files = dt.files

    handleFiles(files)
  }


  function handleFiles(files) {
    const file0 = files[0];
    uploadFile(file0);
  }



  async function uploadFile(file0) {
    let errorDisplay = document.getElementById('error');
    let err = '';

    console.log('html');
    console.log(html);
    let url = 'https://wsend.net/createunreg';
    var myHeaders = new Headers();
    //myHeaders.append('Content-Type', 'application/x-www-form-urlencoded');
    myHeaders.append('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
    myHeaders.append('Accept', 'text/plain');
    let response;
    let uid = localStorage.getItem('uid');
    if (!uid) {
      let response = await fetch(url, {
        method: 'POST',
        mode: 'cors',
        cache: 'default',
        headers: myHeaders,
        body: 'start=1'
      });
      uid = await response.text();
      console.log(uid);
      if (uid === '') {
        console.log('uid empty');
        return;
      }
    }
    localStorage.setItem('uid', uid);
    url = 'https://wsend.net/upload_cli';
    formData = new FormData();

    formData.append('filehandle', js);
    formData.append('uid', uid);

    response = await fetch(url, {
      method: 'POST',
      body: formData
    });
    let jslink = await response.text();

    console.log(jslink);
    var t2 = 't2 replace here';
    var reader = new FileReader();
    reader.readAsText(html);
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    reader.onload = function(){
      var text = reader.result;
      console.log("before");
      t2 = text.replace(/e\.src = ".*\.js";/m, `e.src = "${jslink}";`);
      console.log("after");
    };
    await sleep(1000);
    var blob = new Blob([t2], { type: html.type });
    formData = new FormData()

    formData.append('filehandle', blob, html.name);
    formData.append('uid', uid);

    response = await fetch(url, {
      method: 'POST',
      body: formData
    });
    let wsendLink = await response.text();
    // set profile image here
  }


})
</script>
</html>
